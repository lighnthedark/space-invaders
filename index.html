<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Invaders</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', monospace;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
            padding: 10px 0;
        }

        /* Starfield background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(1px 1px at 20px 30px, #fff, transparent),
                radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 50px 160px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 160px 120px, #fff, transparent),
                radial-gradient(1px 1px at 200px 50px, rgba(255,255,255,0.5), transparent),
                radial-gradient(1px 1px at 220px 150px, #fff, transparent),
                radial-gradient(1px 1px at 270px 90px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 300px 180px, #fff, transparent),
                radial-gradient(1px 1px at 350px 30px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 380px 100px, #fff, transparent),
                radial-gradient(1px 1px at 420px 60px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 450px 140px, #fff, transparent),
                radial-gradient(1px 1px at 500px 200px, rgba(255,255,255,0.5), transparent);
            background-size: 550px 250px;
            animation: twinkle 4s ease-in-out infinite alternate;
            z-index: -1;
        }

        @keyframes twinkle {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .game-cabinet {
            background: linear-gradient(145deg, #1a1a2e, #0f0f1a);
            border: 4px solid #2d2d4a;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 
                0 0 60px rgba(0, 255, 136, 0.15),
                inset 0 0 30px rgba(0, 0, 0, 0.5);
            max-width: 95vw;
        }

        @media (max-width: 600px) {
            .game-cabinet {
                padding: 10px;
                border-radius: 8px;
            }
            
            .game-screen {
                width: 100%;
            }
            
            canvas {
                width: 100%;
                height: auto;
            }
            
            .header {
                flex-wrap: wrap;
                gap: 5px;
                justify-content: center;
            }
            
            .score-display, .high-score-display, .lives-display {
                font-size: 9px;
            }
            
            .title {
                font-size: 18px;
            }
            
            .subtitle {
                font-size: 8px;
                margin-bottom: 25px;
            }
            
            .start-btn {
                font-size: 10px;
                padding: 12px 20px;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .score-display, .high-score-display, .lives-display {
            color: #00ff88;
            font-size: 12px;
            text-shadow: 0 0 10px #00ff88;
        }

        .high-score-display {
            color: #ff6b6b;
            text-shadow: 0 0 10px #ff6b6b;
        }

        .lives-display {
            color: #4ecdc4;
            text-shadow: 0 0 10px #4ecdc4;
        }

        .game-screen {
            position: relative;
            background: #000;
            border: 3px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }

        /* CRT scanline effect */
        .game-screen::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
            pointer-events: none;
        }

        /* CRT glow */
        .game-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 100px rgba(0, 255, 136, 0.05);
            pointer-events: none;
            z-index: 10;
        }

        canvas {
            display: block;
        }

        .controls-info {
            margin-top: 15px;
            text-align: center;
            color: #666;
            font-size: 8px;
            letter-spacing: 1px;
        }

        .controls-info span {
            color: #00ff88;
        }

        /* Start screen overlay */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .overlay.hidden {
            display: none;
        }

        .title {
            color: #00ff88;
            font-size: 24px;
            margin-bottom: 10px;
            text-shadow: 
                0 0 20px #00ff88,
                0 0 40px #00ff88,
                0 0 60px #00ff88;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .subtitle {
            color: #4ecdc4;
            font-size: 10px;
            margin-bottom: 40px;
            text-shadow: 0 0 10px #4ecdc4;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .start-btn {
            background: transparent;
            border: 2px solid #00ff88;
            color: #00ff88;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px #00ff88;
            animation: blink 1s step-end infinite;
        }

        .start-btn:hover {
            background: #00ff88;
            color: #0a0a0f;
            box-shadow: 0 0 30px #00ff88;
            text-shadow: none;
        }

        .difficulty-select {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .diff-label {
            color: #4ecdc4;
            font-size: 10px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #4ecdc4;
        }

        .diff-btn {
            background: transparent;
            border: 2px solid #00ff88;
            color: #00ff88;
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            padding: 12px 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px #00ff88;
            width: 200px;
        }

        .diff-btn:hover {
            background: #00ff88;
            color: #0a0a0f;
            box-shadow: 0 0 30px #00ff88;
            text-shadow: none;
        }

        #easyBtn {
            border-color: #4ecdc4;
            color: #4ecdc4;
            text-shadow: 0 0 10px #4ecdc4;
        }

        #easyBtn:hover {
            background: #4ecdc4;
            color: #0a0a0f;
            box-shadow: 0 0 30px #4ecdc4;
        }

        #hardBtn {
            border-color: #ff6b6b;
            color: #ff6b6b;
            text-shadow: 0 0 10px #ff6b6b;
        }

        #hardBtn:hover {
            background: #ff6b6b;
            color: #0a0a0f;
            box-shadow: 0 0 30px #ff6b6b;
        }

        @keyframes blink {
            50% { border-color: transparent; }
        }

        .game-over-text {
            color: #ff6b6b;
            font-size: 20px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ff6b6b;
        }

        .final-score {
            color: #fff;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .level-display {
            color: #ffd93d;
            font-size: 10px;
            text-shadow: 0 0 10px #ffd93d;
        }

        .wave-announce {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd93d;
            font-size: 16px;
            text-shadow: 0 0 20px #ffd93d;
            z-index: 15;
            animation: waveIn 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes waveIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Mobile touch controls */
        .touch-controls {
            display: flex;
            margin-top: 20px;
            gap: 15px;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .gyro-toggle {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .touch-btn {
            background: rgba(0, 255, 136, 0.2);
            border: 3px solid #00ff88;
            color: #00ff88;
            font-family: 'Press Start 2P', monospace;
            font-size: 24px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .touch-btn:active {
            background: rgba(0, 255, 136, 0.5);
            transform: scale(0.95);
        }

        .touch-fire {
            width: 90px;
            height: 90px;
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
            font-size: 30px;
        }

        .gyro-btn {
            width: auto !important;
            height: auto !important;
            padding: 10px 20px !important;
            font-size: 10px !important;
            border-radius: 8px !important;
            border-color: #666;
            color: #666;
        }

        @media (max-width: 1024px) {
            .controls-info {
                display: none;
            }
        }
        
        @media (max-width: 400px) {
            .touch-btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }
            .touch-fire {
                width: 75px;
                height: 75px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="game-cabinet">
        <div class="header">
            <div class="score-display">SCORE: <span id="score">0</span></div>
            <div class="high-score-display">HI: <span id="high-score">0</span></div>
            <div class="lives-display">LIVES: <span id="lives">3</span></div>
        </div>
        
        <div class="game-screen">
            <canvas id="gameCanvas" width="560" height="600"></canvas>
            
            <div id="startOverlay" class="overlay">
                <div class="title">SPACE</div>
                <div class="title" style="color: #ff6b6b; text-shadow: 0 0 20px #ff6b6b, 0 0 40px #ff6b6b;">INVADERS</div>
                <div class="subtitle">DEFEND EARTH</div>
                <div class="difficulty-select">
                    <div class="diff-label">SELECT DIFFICULTY</div>
                    <button class="diff-btn" id="easyBtn">EASY</button>
                    <button class="diff-btn" id="normalBtn">NORMAL</button>
                    <button class="diff-btn" id="hardBtn">HARD</button>
                </div>
            </div>
            
            <div id="gameOverOverlay" class="overlay hidden">
                <div class="game-over-text">GAME OVER</div>
                <div class="final-score">SCORE: <span id="finalScore">0</span></div>
                <button class="start-btn" id="restartBtn">PLAY AGAIN</button>
            </div>
        </div>
        
        <div class="controls-info">
            <span>←</span> <span>→</span> MOVE &nbsp;&nbsp; <span>SPACE</span> FIRE &nbsp;&nbsp; <span>P</span> PAUSE
        </div>
        
        <div class="touch-controls">
            <button class="touch-btn" id="leftBtn">◀</button>
            <button class="touch-btn touch-fire" id="fireBtn">●</button>
            <button class="touch-btn" id="rightBtn">▶</button>
        </div>
        <div class="gyro-toggle">
            <button class="touch-btn gyro-btn" id="gyroBtn">GYRO: OFF</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game state
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let highScore = localStorage.getItem('spaceInvadersHighScore') || 0;
        let lives = 3;
        let wave = 1;
        let waveAnnouncement = null;
        let difficulty = 'normal';
        
        // Difficulty settings
        const difficultySettings = {
            easy: {
                lives: 5,
                alienSpeed: 0.6,
                alienShootChance: 0.001,
                bulletSpeed: 10,
                shootCooldown: 200
            },
            normal: {
                lives: 3,
                alienSpeed: 1,
                alienShootChance: 0.002,
                bulletSpeed: 8,
                shootCooldown: 250
            },
            hard: {
                lives: 2,
                alienSpeed: 1.5,
                alienShootChance: 0.004,
                bulletSpeed: 7,
                shootCooldown: 300
            }
        };
        
        // Update high score display
        document.getElementById('high-score').textContent = highScore;
        
        // Player
        const player = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 60,
            width: 50,
            height: 30,
            speed: 6,
            dx: 0
        };
        
        // Bullets
        let playerBullets = [];
        let alienBullets = [];
        let bulletSpeed = 8;
        const alienBulletSpeed = 4;
        let canShoot = true;
        let shootCooldown = 250;
        
        // Aliens
        let aliens = [];
        const alienRows = 5;
        const alienCols = 11;
        let alienDirection = 1;
        let alienSpeed = 1;
        let alienDropAmount = 20;
        let alienShootChance = 0.002;
        
        // Shields
        let shields = [];
        
        // Mystery ship
        let mysteryShip = null;
        let mysteryShipTimer = 0;
        
        // Explosions
        let explosions = [];
        
        // Colors for different alien types
        const alienColors = ['#ff6b6b', '#ffd93d', '#4ecdc4', '#95e1d3', '#00ff88'];
        
        // Initialize aliens
        function initAliens() {
            aliens = [];
            for (let row = 0; row < alienRows; row++) {
                for (let col = 0; col < alienCols; col++) {
                    aliens.push({
                        x: 50 + col * 45,
                        y: 80 + row * 40,
                        width: 35,
                        height: 25,
                        row: row,
                        alive: true,
                        frame: 0
                    });
                }
            }
        }
        
        // Initialize shields
        function initShields() {
            shields = [];
            const shieldWidth = 60;
            const shieldHeight = 40;
            const shieldY = canvas.height - 130;
            const positions = [70, 180, 310, 420];
            
            positions.forEach(x => {
                shields.push({
                    x: x,
                    y: shieldY,
                    width: shieldWidth,
                    height: shieldHeight,
                    pixels: createShieldPixels()
                });
            });
        }
        
        function createShieldPixels() {
            const pixels = [];
            const cols = 12;
            const rows = 8;
            for (let r = 0; r < rows; r++) {
                pixels[r] = [];
                for (let c = 0; c < cols; c++) {
                    // Create arch shape
                    if (r < 2 || (r >= 6 && (c < 4 || c > 7))) {
                        if (r < 2 && (c < 2 || c > 9)) {
                            pixels[r][c] = false;
                        } else {
                            pixels[r][c] = true;
                        }
                    } else if (r >= 6 && c >= 4 && c <= 7) {
                        pixels[r][c] = false;
                    } else {
                        pixels[r][c] = true;
                    }
                }
            }
            return pixels;
        }
        
        // Draw player ship
        function drawPlayer() {
            ctx.fillStyle = '#00ff88';
            ctx.shadowColor = '#00ff88';
            ctx.shadowBlur = 10;
            
            // Ship body
            ctx.beginPath();
            ctx.moveTo(player.x + player.width / 2, player.y);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.closePath();
            ctx.fill();
            
            // Cockpit
            ctx.fillStyle = '#4ecdc4';
            ctx.fillRect(player.x + player.width / 2 - 5, player.y + 8, 10, 8);
            
            ctx.shadowBlur = 0;
        }
        
        // Draw aliens
        function drawAliens() {
            aliens.forEach(alien => {
                if (!alien.alive) return;
                
                const color = alienColors[alien.row];
                ctx.fillStyle = color;
                ctx.shadowColor = color;
                ctx.shadowBlur = 8;
                
                const x = alien.x;
                const y = alien.y;
                const w = alien.width;
                const h = alien.height;
                
                // Different shapes for different rows
                if (alien.row === 0) {
                    // Top row - squid
                    drawSquidAlien(x, y, w, h, alien.frame);
                } else if (alien.row < 3) {
                    // Middle rows - crab
                    drawCrabAlien(x, y, w, h, alien.frame);
                } else {
                    // Bottom rows - octopus
                    drawOctopusAlien(x, y, w, h, alien.frame);
                }
                
                ctx.shadowBlur = 0;
            });
        }
        
        function drawSquidAlien(x, y, w, h, frame) {
            ctx.beginPath();
            ctx.fillRect(x + w * 0.35, y, w * 0.3, h * 0.3);
            ctx.fillRect(x + w * 0.2, y + h * 0.3, w * 0.6, h * 0.4);
            ctx.fillRect(x + w * 0.1, y + h * 0.5, w * 0.8, h * 0.3);
            if (frame === 0) {
                ctx.fillRect(x, y + h * 0.7, w * 0.2, h * 0.3);
                ctx.fillRect(x + w * 0.8, y + h * 0.7, w * 0.2, h * 0.3);
            } else {
                ctx.fillRect(x + w * 0.15, y + h * 0.8, w * 0.15, h * 0.2);
                ctx.fillRect(x + w * 0.7, y + h * 0.8, w * 0.15, h * 0.2);
            }
        }
        
        function drawCrabAlien(x, y, w, h, frame) {
            ctx.fillRect(x + w * 0.2, y, w * 0.6, h * 0.4);
            ctx.fillRect(x + w * 0.1, y + h * 0.3, w * 0.8, h * 0.4);
            ctx.fillRect(x, y + h * 0.5, w, h * 0.2);
            if (frame === 0) {
                ctx.fillRect(x, y + h * 0.2, w * 0.15, h * 0.3);
                ctx.fillRect(x + w * 0.85, y + h * 0.2, w * 0.15, h * 0.3);
                ctx.fillRect(x + w * 0.15, y + h * 0.7, w * 0.2, h * 0.3);
                ctx.fillRect(x + w * 0.65, y + h * 0.7, w * 0.2, h * 0.3);
            } else {
                ctx.fillRect(x - w * 0.1, y + h * 0.4, w * 0.15, h * 0.3);
                ctx.fillRect(x + w * 0.95, y + h * 0.4, w * 0.15, h * 0.3);
                ctx.fillRect(x, y + h * 0.7, w * 0.2, h * 0.3);
                ctx.fillRect(x + w * 0.8, y + h * 0.7, w * 0.2, h * 0.3);
            }
        }
        
        function drawOctopusAlien(x, y, w, h, frame) {
            ctx.fillRect(x + w * 0.3, y, w * 0.4, h * 0.3);
            ctx.fillRect(x + w * 0.15, y + h * 0.2, w * 0.7, h * 0.4);
            ctx.fillRect(x + w * 0.05, y + h * 0.4, w * 0.9, h * 0.3);
            if (frame === 0) {
                ctx.fillRect(x, y + h * 0.7, w * 0.25, h * 0.3);
                ctx.fillRect(x + w * 0.35, y + h * 0.7, w * 0.3, h * 0.3);
                ctx.fillRect(x + w * 0.75, y + h * 0.7, w * 0.25, h * 0.3);
            } else {
                ctx.fillRect(x + w * 0.1, y + h * 0.7, w * 0.2, h * 0.3);
                ctx.fillRect(x + w * 0.4, y + h * 0.7, w * 0.2, h * 0.3);
                ctx.fillRect(x + w * 0.7, y + h * 0.7, w * 0.2, h * 0.3);
            }
        }
        
        // Draw mystery ship
        function drawMysteryShip() {
            if (!mysteryShip) return;
            
            ctx.fillStyle = '#ff00ff';
            ctx.shadowColor = '#ff00ff';
            ctx.shadowBlur = 15;
            
            const x = mysteryShip.x;
            const y = mysteryShip.y;
            const w = mysteryShip.width;
            const h = mysteryShip.height;
            
            ctx.beginPath();
            ctx.ellipse(x + w / 2, y + h / 2, w / 2, h / 3, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.ellipse(x + w / 2, y + h / 3, w / 4, h / 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.shadowBlur = 0;
        }
        
        // Draw shields
        function drawShields() {
            shields.forEach(shield => {
                const pixelWidth = shield.width / 12;
                const pixelHeight = shield.height / 8;
                
                ctx.fillStyle = '#00ff88';
                shield.pixels.forEach((row, r) => {
                    row.forEach((pixel, c) => {
                        if (pixel) {
                            ctx.fillRect(
                                shield.x + c * pixelWidth,
                                shield.y + r * pixelHeight,
                                pixelWidth,
                                pixelHeight
                            );
                        }
                    });
                });
            });
        }
        
        // Draw bullets
        function drawBullets() {
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#fff';
            ctx.shadowBlur = 5;
            
            playerBullets.forEach(bullet => {
                ctx.fillRect(bullet.x - 2, bullet.y, 4, 15);
            });
            
            ctx.fillStyle = '#ff6b6b';
            ctx.shadowColor = '#ff6b6b';
            
            alienBullets.forEach(bullet => {
                ctx.beginPath();
                ctx.moveTo(bullet.x, bullet.y);
                ctx.lineTo(bullet.x - 3, bullet.y + 10);
                ctx.lineTo(bullet.x + 3, bullet.y + 10);
                ctx.closePath();
                ctx.fill();
            });
            
            ctx.shadowBlur = 0;
        }
        
        // Draw explosions
        function drawExplosions() {
            explosions.forEach(exp => {
                ctx.fillStyle = exp.color;
                ctx.shadowColor = exp.color;
                ctx.shadowBlur = 20;
                
                const particles = 8;
                for (let i = 0; i < particles; i++) {
                    const angle = (Math.PI * 2 / particles) * i;
                    const distance = exp.radius * (exp.frame / exp.maxFrames);
                    const x = exp.x + Math.cos(angle) * distance;
                    const y = exp.y + Math.sin(angle) * distance;
                    const size = 4 * (1 - exp.frame / exp.maxFrames);
                    ctx.fillRect(x - size / 2, y - size / 2, size, size);
                }
                
                ctx.shadowBlur = 0;
            });
        }
        
        // Update functions
        function updatePlayer() {
            player.x += player.dx;
            
            // Boundary check
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
        }
        
        function updateBullets() {
            // Player bullets
            playerBullets = playerBullets.filter(bullet => {
                bullet.y -= bulletSpeed;
                return bullet.y > -20;
            });
            
            // Alien bullets
            alienBullets = alienBullets.filter(bullet => {
                bullet.y += alienBulletSpeed;
                return bullet.y < canvas.height + 20;
            });
        }
        
        function updateAliens() {
            let hitEdge = false;
            let lowestY = 0;
            
            aliens.forEach(alien => {
                if (!alien.alive) return;
                
                alien.x += alienSpeed * alienDirection;
                
                if (alien.x <= 0 || alien.x + alien.width >= canvas.width) {
                    hitEdge = true;
                }
                
                if (alien.y > lowestY) lowestY = alien.y;
            });
            
            if (hitEdge) {
                alienDirection *= -1;
                aliens.forEach(alien => {
                    alien.y += alienDropAmount;
                });
            }
            
            // Check if aliens reached player
            if (lowestY + 30 > player.y) {
                gameOver();
            }
            
            // Alien shooting
            const aliveAliens = aliens.filter(a => a.alive);
            if (aliveAliens.length > 0 && Math.random() < alienShootChance * aliveAliens.length) {
                const shooter = aliveAliens[Math.floor(Math.random() * aliveAliens.length)];
                alienBullets.push({
                    x: shooter.x + shooter.width / 2,
                    y: shooter.y + shooter.height
                });
            }
            
            // Animate aliens
            if (Math.random() < 0.05) {
                aliens.forEach(alien => {
                    alien.frame = alien.frame === 0 ? 1 : 0;
                });
            }
        }
        
        function updateMysteryShip() {
            if (mysteryShip) {
                mysteryShip.x += mysteryShip.speed;
                if (mysteryShip.x > canvas.width + 50 || mysteryShip.x < -100) {
                    mysteryShip = null;
                }
            } else {
                mysteryShipTimer++;
                if (mysteryShipTimer > 800 && Math.random() < 0.005) {
                    const fromLeft = Math.random() > 0.5;
                    mysteryShip = {
                        x: fromLeft ? -50 : canvas.width + 50,
                        y: 30,
                        width: 50,
                        height: 20,
                        speed: fromLeft ? 2 : -2
                    };
                    mysteryShipTimer = 0;
                }
            }
        }
        
        function updateExplosions() {
            explosions = explosions.filter(exp => {
                exp.frame++;
                return exp.frame < exp.maxFrames;
            });
        }
        
        function checkCollisions() {
            // Player bullets vs aliens
            playerBullets.forEach((bullet, bIndex) => {
                aliens.forEach(alien => {
                    if (!alien.alive) return;
                    
                    if (bullet.x > alien.x && bullet.x < alien.x + alien.width &&
                        bullet.y > alien.y && bullet.y < alien.y + alien.height) {
                        alien.alive = false;
                        playerBullets.splice(bIndex, 1);
                        
                        // Score based on row
                        const points = (alienRows - alien.row) * 10;
                        score += points;
                        document.getElementById('score').textContent = score;
                        
                        // Explosion
                        explosions.push({
                            x: alien.x + alien.width / 2,
                            y: alien.y + alien.height / 2,
                            frame: 0,
                            maxFrames: 15,
                            radius: 25,
                            color: alienColors[alien.row]
                        });
                    }
                });
                
                // Player bullets vs mystery ship
                if (mysteryShip &&
                    bullet.x > mysteryShip.x && bullet.x < mysteryShip.x + mysteryShip.width &&
                    bullet.y > mysteryShip.y && bullet.y < mysteryShip.y + mysteryShip.height) {
                    const points = [50, 100, 150, 300][Math.floor(Math.random() * 4)];
                    score += points;
                    document.getElementById('score').textContent = score;
                    
                    explosions.push({
                        x: mysteryShip.x + mysteryShip.width / 2,
                        y: mysteryShip.y + mysteryShip.height / 2,
                        frame: 0,
                        maxFrames: 20,
                        radius: 35,
                        color: '#ff00ff'
                    });
                    
                    mysteryShip = null;
                    playerBullets.splice(bIndex, 1);
                }
            });
            
            // Alien bullets vs player
            alienBullets.forEach((bullet, bIndex) => {
                if (bullet.x > player.x && bullet.x < player.x + player.width &&
                    bullet.y > player.y && bullet.y < player.y + player.height) {
                    alienBullets.splice(bIndex, 1);
                    loseLife();
                }
            });
            
            // Bullets vs shields
            shields.forEach(shield => {
                // Player bullets
                playerBullets.forEach((bullet, bIndex) => {
                    if (checkShieldCollision(shield, bullet.x, bullet.y, 4, 15)) {
                        playerBullets.splice(bIndex, 1);
                    }
                });
                
                // Alien bullets
                alienBullets.forEach((bullet, bIndex) => {
                    if (checkShieldCollision(shield, bullet.x - 3, bullet.y, 6, 10)) {
                        alienBullets.splice(bIndex, 1);
                    }
                });
            });
            
            // Aliens vs shields
            aliens.forEach(alien => {
                if (!alien.alive) return;
                shields.forEach(shield => {
                    if (alien.x < shield.x + shield.width &&
                        alien.x + alien.width > shield.x &&
                        alien.y < shield.y + shield.height &&
                        alien.y + alien.height > shield.y) {
                        damageShieldArea(shield, alien.x, alien.y, alien.width, alien.height);
                    }
                });
            });
            
            // Check if all aliens dead
            if (aliens.every(a => !a.alive)) {
                nextWave();
            }
        }
        
        function checkShieldCollision(shield, bx, by, bw, bh) {
            const pixelWidth = shield.width / 12;
            const pixelHeight = shield.height / 8;
            
            let hit = false;
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 12; c++) {
                    if (!shield.pixels[r][c]) continue;
                    
                    const px = shield.x + c * pixelWidth;
                    const py = shield.y + r * pixelHeight;
                    
                    if (bx < px + pixelWidth && bx + bw > px &&
                        by < py + pixelHeight && by + bh > py) {
                        shield.pixels[r][c] = false;
                        // Damage nearby pixels
                        if (r > 0) shield.pixels[r - 1][c] = false;
                        if (r < 7) shield.pixels[r + 1][c] = false;
                        if (c > 0) shield.pixels[r][c - 1] = false;
                        if (c < 11) shield.pixels[r][c + 1] = false;
                        hit = true;
                    }
                }
            }
            
            return hit;
        }
        
        function damageShieldArea(shield, ax, ay, aw, ah) {
            const pixelWidth = shield.width / 12;
            const pixelHeight = shield.height / 8;
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 12; c++) {
                    const px = shield.x + c * pixelWidth;
                    const py = shield.y + r * pixelHeight;
                    
                    if (ax < px + pixelWidth && ax + aw > px &&
                        ay < py + pixelHeight && ay + ah > py) {
                        shield.pixels[r][c] = false;
                    }
                }
            }
        }
        
        function loseLife() {
            lives--;
            document.getElementById('lives').textContent = lives;
            
            explosions.push({
                x: player.x + player.width / 2,
                y: player.y + player.height / 2,
                frame: 0,
                maxFrames: 30,
                radius: 40,
                color: '#00ff88'
            });
            
            if (lives <= 0) {
                gameOver();
            } else {
                // Reset player position
                player.x = canvas.width / 2 - 25;
                alienBullets = [];
            }
        }
        
        function nextWave() {
            wave++;
            
            // Increase difficulty based on starting difficulty
            const settings = difficultySettings[difficulty];
            alienSpeed = Math.min(3, settings.alienSpeed + wave * 0.2);
            alienShootChance = Math.min(0.01, settings.alienShootChance + wave * 0.0005);
            
            // Reset
            initAliens();
            alienDirection = 1;
            playerBullets = [];
            alienBullets = [];
            player.x = canvas.width / 2 - 25;
            
            // Show wave announcement
            showWaveAnnouncement();
        }
        
        function showWaveAnnouncement() {
            const existing = document.querySelector('.wave-announce');
            if (existing) existing.remove();
            
            const announce = document.createElement('div');
            announce.className = 'wave-announce';
            announce.textContent = `WAVE ${wave}`;
            document.querySelector('.game-screen').appendChild(announce);
            
            setTimeout(() => announce.remove(), 2000);
        }
        
        function gameOver() {
            gameRunning = false;
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('spaceInvadersHighScore', highScore);
                document.getElementById('high-score').textContent = highScore;
            }
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('gameOverOverlay').classList.remove('hidden');
        }
        
        function shoot() {
            if (!canShoot || !gameRunning || gamePaused) return;
            
            playerBullets.push({
                x: player.x + player.width / 2,
                y: player.y
            });
            
            canShoot = false;
            setTimeout(() => canShoot = true, shootCooldown);
        }
        
        // Game loop
        function gameLoop() {
            if (!gameRunning) return;
            
            if (!gamePaused) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                updatePlayer();
                updateBullets();
                updateAliens();
                updateMysteryShip();
                updateExplosions();
                checkCollisions();
                
                drawShields();
                drawAliens();
                drawMysteryShip();
                drawPlayer();
                drawBullets();
                drawExplosions();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function startGame(selectedDifficulty) {
            difficulty = selectedDifficulty || 'normal';
            const settings = difficultySettings[difficulty];
            
            score = 0;
            lives = settings.lives;
            wave = 1;
            alienSpeed = settings.alienSpeed;
            alienShootChance = settings.alienShootChance;
            bulletSpeed = settings.bulletSpeed;
            shootCooldown = settings.shootCooldown;
            alienDirection = 1;
            
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = lives;
            
            player.x = canvas.width / 2 - 25;
            playerBullets = [];
            alienBullets = [];
            explosions = [];
            mysteryShip = null;
            mysteryShipTimer = 0;
            
            initAliens();
            initShields();
            
            document.getElementById('startOverlay').classList.add('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');
            
            gameRunning = true;
            gamePaused = false;
            
            showWaveAnnouncement();
            gameLoop();
        }
        
        // Controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') {
                player.dx = -player.speed;
            } else if (e.key === 'ArrowRight' || e.key === 'd') {
                player.dx = player.speed;
            } else if (e.key === ' ') {
                e.preventDefault();
                shoot();
            } else if (e.key === 'p' || e.key === 'P') {
                gamePaused = !gamePaused;
            } else if (e.key === 'Enter' && !gameRunning) {
                startGame('normal');
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if ((e.key === 'ArrowLeft' || e.key === 'a') && player.dx < 0) {
                player.dx = 0;
            } else if ((e.key === 'ArrowRight' || e.key === 'd') && player.dx > 0) {
                player.dx = 0;
            }
        });
        
        // Touch controls (fallback if no gyroscope)
        document.getElementById('leftBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.dx = -player.speed;
        });
        document.getElementById('leftBtn').addEventListener('touchend', () => {
            player.dx = 0;
        });
        
        document.getElementById('rightBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.dx = player.speed;
        });
        document.getElementById('rightBtn').addEventListener('touchend', () => {
            player.dx = 0;
        });
        
        document.getElementById('fireBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            shoot();
        });
        
        // Gyroscope controls
        let gyroEnabled = false;
        const gyroSensitivity = 0.4; // Adjust how sensitive the tilt is
        
        function handleGyro(event) {
            if (!gyroEnabled || !gameRunning || gamePaused) return;
            
            // gamma is left/right tilt (-90 to 90 degrees)
            const tilt = event.gamma;
            
            // Dead zone - ignore very small tilts
            if (Math.abs(tilt) < 5) {
                player.dx = 0;
            } else {
                // Convert tilt to player movement
                player.dx = tilt * gyroSensitivity;
                
                // Cap the speed
                if (player.dx > player.speed) player.dx = player.speed;
                if (player.dx < -player.speed) player.dx = -player.speed;
            }
        }
        
        // Request gyroscope permission (required on iOS)
        function enableGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleGyro);
                            gyroEnabled = true;
                            document.getElementById('gyroBtn').textContent = 'GYRO: ON';
                            document.getElementById('gyroBtn').style.borderColor = '#00ff88';
                            document.getElementById('gyroBtn').style.color = '#00ff88';
                            // Hide left/right buttons when gyro is on
                            document.getElementById('leftBtn').style.opacity = '0.3';
                            document.getElementById('rightBtn').style.opacity = '0.3';
                        }
                    })
                    .catch(console.error);
            } else if ('DeviceOrientationEvent' in window) {
                // Non-iOS devices
                window.addEventListener('deviceorientation', handleGyro);
                gyroEnabled = true;
                document.getElementById('gyroBtn').textContent = 'GYRO: ON';
                document.getElementById('gyroBtn').style.borderColor = '#00ff88';
                document.getElementById('gyroBtn').style.color = '#00ff88';
                document.getElementById('leftBtn').style.opacity = '0.3';
                document.getElementById('rightBtn').style.opacity = '0.3';
            } else {
                alert('Gyroscope not available on this device');
            }
        }
        
        function toggleGyro() {
            if (gyroEnabled) {
                window.removeEventListener('deviceorientation', handleGyro);
                gyroEnabled = false;
                player.dx = 0;
                document.getElementById('gyroBtn').textContent = 'GYRO: OFF';
                document.getElementById('gyroBtn').style.borderColor = '#666';
                document.getElementById('gyroBtn').style.color = '#666';
                document.getElementById('leftBtn').style.opacity = '1';
                document.getElementById('rightBtn').style.opacity = '1';
            } else {
                enableGyro();
            }
        }
        
        // Add gyro button listener
        document.getElementById('gyroBtn').addEventListener('click', toggleGyro);
        
        // Tap anywhere on canvas to fire (when gyro enabled)
        canvas.addEventListener('touchstart', (e) => {
            if (gyroEnabled && gameRunning) {
                e.preventDefault();
                shoot();
            }
        });
        
        // Button handlers
        document.getElementById('easyBtn').addEventListener('click', () => startGame('easy'));
        document.getElementById('normalBtn').addEventListener('click', () => startGame('normal'));
        document.getElementById('hardBtn').addEventListener('click', () => startGame('hard'));
        document.getElementById('restartBtn').addEventListener('click', () => startGame(difficulty));
    </script>
</body>
</html>
